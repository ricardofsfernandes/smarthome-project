<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartHome - Lista de Compras</title>
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div class="container">
        <header>
            <h2>Mercado <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart-icon lucide-shopping-cart"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg></h2>
        </header>

        <div class="input-group">
            <input type="text" id="itemInput" placeholder="Item (ex: Pão)">
            <input type="number" id="qtdInput" placeholder="0" inputmode="numeric" pattern="[0-9]*">
            <button id="add-btn" onclick="adicionarItem()">Adicionar Item</button>
            <select id="unitInput">
                <option value="un">Uni</option>
                <option value="kg">kg</option>
                <option value="g">Gr</option>
                <option value="pack">Pack</option>
                <option value="Lt">Lt</option>
            </select>
        </div>

        <div id="lista-compras">
            <p style="text-align:center;">A carregar lista...</p>
        </div>
    </div>

    <script>
    // URL do teu Backend no Render
    const API_URL = 'https://smarthome-project.onrender.com/compras';

    async function carregarLista() {
        try {
            const res = await fetch(API_URL);
            const dados = await res.json();
            renderizarLista(dados);
        } catch (err) {
            console.error("Erro ao carregar:", err);
        }
    }

    // 1. Atualizamos a renderização para verificar o estado 'concluido'
function renderizarLista(itens) {
    const container = document.getElementById('lista-compras');
    container.innerHTML = '';
    
    itens.forEach(item => {
        const partes = item.item.split('|');
        const nomeExibicao = partes[0];
        const unidadeExibicao = partes[1] || 'un';
        
        // Verifica se o item está concluído para aplicar o estilo
        const estiloRiscado = item.concluido 
    ? 'text-decoration: line-through; opacity: 0.5; color: #ef4444;' 
    : '';

        container.innerHTML += `
            <div class="item" onclick="alternarConcluido('${item._id}', ${item.concluido})" style="cursor: pointer;">
                <div style="${estiloRiscado}">
                    <strong style="font-size: 1.1rem; display: block; margin-bottom: 2px;">${nomeExibicao}</strong>
                    <small style="color: #94a3b8; font-size: 0.9rem; font-weight: 500;">
                        Qtd: ${item.quantidade} ${unidadeExibicao}
                    </small>
                </div>
                <button class="del-btn" onclick="event.stopPropagation(); apagarItem('${item._id}')">Apagar</button>
            </div>
        `;
    });
}

// 2. Nova função para riscar/desriscar
async function alternarConcluido(id) {
    try {
        // Como API_URL já tem '/compras', aqui só adicionamos '/alternar/'
        const res = await fetch(`${API_URL}/alternar/${id}`, {
            method: 'PATCH'
        });
        
        if (res.status === 404) {
            console.error("Erro 404: Rota não encontrada. Verifica o Deploy no Render.");
            return;
        }

        const novaLista = await res.json();
        renderizarLista(novaLista);
    } catch (err) {
        console.error("Erro na ligação:", err);
    }
}

    async function adicionarItem() {
        const itemInput = document.getElementById('itemInput');
        const qtdInput = document.getElementById('qtdInput');
        const unitInput = document.getElementById('unitInput');

        const nome = itemInput.value.trim();
        const qtd = qtdInput.value || 0;
        const unidade = unitInput.value;

        if (!nome) return alert("Escreve o item!");

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    // Enviamos o nome e a unidade separados por '|'
                    // Exemplo: "Cerveja|pack"
                    item: `${nome}|${unidade}`, 
                    quantidade: qtd 
                })
            });
            
            const novaLista = await res.json();
            renderizarLista(novaLista);
            
            // Limpeza dos campos
            itemInput.value = '';
            qtdInput.value = '';
            unitInput.value = 'un'; 
            itemInput.focus();
        } catch (err) {
            alert("Erro ao adicionar!");
        }
    }

    async function apagarItem(id) {
    try {
        // Como API_URL já tem '/compras', aqui só adicionamos '/limpar/'
        const res = await fetch(`${API_URL}/limpar/${id}`);
        
        if (!res.ok) throw new Error("Erro ao apagar");

        const novaLista = await res.json();
        renderizarLista(novaLista);
    } catch (err) {
        console.error("Erro ao apagar:", err);
        alert("Erro ao apagar!");
    }
}

    // Iniciar
    carregarLista();
</script>
</body>
</html>